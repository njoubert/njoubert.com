<!DOCTYPE html>

<html>
<head>
  <title>Z00M</title>
</head>
<style>
body {
	background-color: black;
	color: white;
;}
</style>
<body>
<h1>Z00M is definitely not Zoom</h1>
<div id="controls">
	<p>Controls:</p>
	<select name="cameraSelector" id="cameraSelector"></select>
</div>
<div id="selfview">
	<p>Self View</p>
	<video id="localVideo" autoplay playsinline controls="false"/>
</div>
<div id="otherview">
	<p>Other View</p>
	<video id="remoteVideo" autoplay playsinline controls="false">
</div>
</body>
<script>
var state = {};

function getConnectedDevices(type, callback) {
	navigator.mediaDevices.enumerateDevices()
  	.then(devices => {
    	const filtered = devices.filter(device => device.kind === type);
      callback(filtered);
    });
}

function updateVideoSelector(cameras) {
	cs = document.getElementById('cameraSelector');
	cs.innerHTML = '';
	const selectedDeviceId = window.localStorage.getItem('cameraId');
	cameras.map(camera => {
		const co = document.createElement('option');
		co.label = camera.label;
		co.value = camera.deviceId;
		co.innerHTML = camera.label;
		if (camera.deviceId == selectedDeviceId) {
			co.selected = 'selected'
		}
		return co;
	}).forEach(co => cs.add(co));
}

function playVideoFromCamera(deviceId) {
	if (!deviceId && window.localStorage.getItem('cameraId')) {
		deviceId = window.localStorage.getItem('cameraId');
	}		
  try {
		const constraints = {
			audio: false,			
			video: {
				deviceId: deviceId,
				width:  { ideal: 1280 },
				height: { ideal: 720 }
			}, 
		};
    const stream = navigator.mediaDevices.getUserMedia(constraints)
			.then(stream => {
	  		const videoElement = document.querySelector('video#localVideo');
		    videoElement.srcObject = stream;
				window.localStorage.setItem('cameraId', deviceId);
			});
   } catch(error) {
      console.error('Error opening video camera.', error);
  }
}

class MessageBus {
	constructor(next) {
		this.lastCount = -1;
		this.lastMessage = null;
		this.callbacks = [];
		this.next = next;
		this.poll();
		this.poller = setInterval(this.poll.bind(this), 500);
	}
	
	poll() {
		var that = this;
		fetch('broadcast.php')
			.then(response => response.json())
			.then(data => {
				if (that.lastCount == -1) {
					that.lastCount = data.count;
					that.lastMessage = data.message;		
					that.next();
				} else if (that.lastCount < data.count) {
						that.lastCount = data.count;
						that.lastMessage = data.message;
						that.callbacks.forEach(function(callback) {
							try {
								callback(data.message);
							} catch (err) { 
								console.log(err);
							}
						});
					}
				}); 	
	}

	send(msg) {
		if (this.lastCount != -1)	{
			this.lastCount += 1;
		}
		fetch('broadcast.php', {
			method: "POST",
			headers: {
				"Accept": "application/json",
				"Content-Type": "application/json"
			},
			body: JSON.stringify(msg),
		});
	}

	addEventListener(callback) {
		this.callbacks.push(callback);
	}
}

function makeCall() {
	const configuration = {
		iceServers: [{urls: 'stun:stun.l.google.com:19302'}]
	}
	const peerConnection = new RTCPeerConnection(configuration);
	peerConnection.createOffer().then(offer => {
		peerConnection.setLocalDescription(offer);
		peerConnection.addEventListener('icecandidate', event => { 
			console.log('peerConnection icecandidate:', event);
		});
		peerConnection.addEventListener('connectionstatechange', event => {
			console.log("hello");
			if (peerConnection.connectionState === 'connected') {
				console.log("Connected!!");
			}
		});
		state.peerConnection = peerConnection;
		state.offer = offer;
		state.bus.addEventListener(function (message) {
			if (message.answer) {
				console.log("We received an answer!!", message);
				const remoteDesc = new RTCSessionDescription(message.answer);
				state.peerConnection.setRemoteDescription(remoteDesc);
			};
		});
		state.bus.send({offer:offer});
	});
}

function beCallee(msg) {
	console.log("wow we got an offer!", msg);
	const configuration = {
		iceServers: [{urls: 'stun:stun.l.google.com:19302'}]
	}
	state.peerConnection.close();
	delete state.peerConnection	
	const peerConnection = new RTCPeerConnection(configuration);
			peerConnection.addEventListener('connectionstatechange', event => {
			console.log("hello");
			if (peerConnection.connectionState === 'connected') {
				console.log("Connected!!");
			}
		});

	peerConnection.setRemoteDescription(new RTCSessionDescription(msg.offer));
	peerConnection.createAnswer()
		.then(answer => {
			peerConnection.setLocalDescription(answer);
			state.bus.send({answer:answer});
			state.peerConnection = peerConnection;
		});	
}

function init() {
	state.bus.addEventListener(function(msg) {
		if (msg.offer) {
			beCallee(msg);		
		}
	});	
	makeCall();

}

// Force https
if (location.protocol !== 'https:') {
    location.replace(`https:${location.href.substring(location.protocol.length)}`);
}

// ONLOAD
document.addEventListener("DOMContentLoaded", function() {


	document.getElementById('cameraSelector').addEventListener('change', event => {
		console.log('option change', event);
		const deviceId = event.target.options[event.target.selectedIndex].value;
		playVideoFromCamera(deviceId);
	});

	navigator.mediaDevices.addEventListener('devicechange', event => {
		console.log('devicechange', event);
		getConnectedDevices('videoinput', updateVideoSelector);
	});
	getConnectedDevices('videoinput', updateVideoSelector);
	playVideoFromCamera();

	state.bus = new MessageBus(init);
	
});

</script>
</html>
