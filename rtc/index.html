<!DOCTYPE html>

<html>
<head>
  <title>Z00M</title>
</head>
<style>
body {
	background-color: black;
	color: white;
;}


</style>
<body>
<h1>Z00M is definitely not Zoom</h1>
<div id="controls">
	<p>Controls:</p>
	<select name="cameraSelector" id="cameraSelector"></select>
</div>
<div id="selfview">
	<p>Self View</p>
	<video id="localVideo" autoplay playsinline constrols="false"/>
</div>
<div id="references">
<p>
<br/>https://www.html5rocks.com/en/tutorials/webrtc/infrastructure/
<br/>https://webrtc.org/getting-started/peer-connections
<br/>https://blog.printf.net/articles/2013/05/17/webrtc-without-a-signaling-server/
</p>
</div>
</body>
<script>
function getConnectedDevices(type, callback) {
	navigator.mediaDevices.enumerateDevices()
  	.then(devices => {
    	const filtered = devices.filter(device => device.kind === type);
      callback(filtered);
    });
}

function updateVideoSelector(cameras) {
	cs = document.getElementById('cameraSelector');
	cs.innerHTML = '';
	const selectedDeviceId = window.localStorage.getItem('cameraId');
	cameras.map(camera => {
		const co = document.createElement('option');
		co.label = camera.label;
		co.value = camera.deviceId;
		co.innerHTML = camera.label;
		if (camera.deviceId == selectedDeviceId) {
			co.selected = 'selected'
		}
		return co;
	}).forEach(co => cs.add(co));
}

function playVideoFromCamera(deviceId) {
	if (!deviceId && window.localStorage.getItem('cameraId')) {
		deviceId = window.localStorage.getItem('cameraId');
	}		
  try {
		const constraints = {
			audio: false,			
			video: {
				deviceId: deviceId,
				width:  { ideal: 1280 },
				height: { ideal: 720 }
			}, 
		};
    const stream = navigator.mediaDevices.getUserMedia(constraints)
			.then(stream => {
	  		const videoElement = document.querySelector('video#localVideo');
		    videoElement.srcObject = stream;
				window.localStorage.setItem('cameraId', deviceId);
			});
   } catch(error) {
      console.error('Error opening video camera.', error);
  }
}

function makeCall() {
	const configuration = {
		iceServers: [{urls: 'stun:stun.l.google.com:19302'}]
	}
	const peerConnection = new RTCPeerConnection(configuration);
	peerConnection.createOffer().then(offer => {
		peerConnection.setLocalDescription(offer);
		console.log(peerConnection);
		console.log(offer);
	});
}

// ONLOAD
document.addEventListener("DOMContentLoaded", function() {

	document.getElementById('cameraSelector').addEventListener('change', event => {
		console.log('option change', event);
		const deviceId = event.target.options[event.target.selectedIndex].value;
		playVideoFromCamera(deviceId);
	});

	navigator.mediaDevices.addEventListener('devicechange', event => {
		console.log('devicechange', event);
		getConnectedDevices('videoinput', updateVideoSelector);
	});
	getConnectedDevices('videoinput', updateVideoSelector);
	playVideoFromCamera();
	
	makeCall();
	

});






</script>
</html>
